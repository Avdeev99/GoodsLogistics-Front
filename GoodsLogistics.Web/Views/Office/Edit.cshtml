@using System.Collections.Specialized
@using GoodsLogistics.Localization.Resources
@model GoodsLogistics.ViewModels.DTO.OfficeViewModel

@{
    ViewData["Title"] = "Edit";
}


<section>
    <div class="container">
        <div class="row account_holder">
            <div class="col-lg-4 account_menu_holder">
                @Html.Partial("_AccountMenuPartial")
            </div>
            <div class="col-lg-8 account_holder_content">

                @using (Html.BeginForm(FormMethod.Post, new { enctype = "multipart/form-data" }))
                {
                    @Html.HiddenFor(model => model.OfficeId)

                    <div class="row form-group">
                        <div class="col-lg-6">
                            @Html.Label(Resources.Key)
                            @Html.EditorFor(model => model.Key, new
                            {
                                htmlAttributes = new
                                {
                                    @class = "input",
                                    placeholder = Resources.Key,
                                    required = "required",
                                    minlength = "2",
                                    id = "officeKey"
                                }
                            })
                            @Html.ValidationMessageFor(m => m.Key, "", new { @class = "text-danger" })
                        </div>
                        <div class="col-lg-6">
                            <label>@Resources.Country</label>
                            <select id="countrySelect" class="input" required>
                                <option value="" selected="selected">@Resources.SelectCountry</option>
                            </select>
                        </div>
                    </div>

                    <div class="row form-group">
                        <div class="col-lg-6">
                            <label>@Resources.Region</label>
                            <select id="regionSelect" class="input">
                                <option value="" selected="selected">@Resources.SelectRegion</option>
                            </select>
                        </div>
                        <div class="col-lg-6">
                            <label>@Resources.City</label>
                            <select id="citySelect" class="input" name="CityId">
                                <option value="" selected="selected">@Resources.SelectCity</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        @Html.Label(Resources.Address)
                        @Html.TextBoxFor(m => m.Address, new
                        {
                            @class = "input",
                            placeholder = Resources.Address,
                            required = "required",
                            minlength = "6"
                        })
                        @Html.ValidationMessageFor(m => m.Address, "", new {@class = "text-danger"})
                    </div>

                    <div class="login_button_holder">
                        <input type="submit" class="button" value="@Resources.Submit">
                    </div>

                    <div class="form-group">
                        @Html.ActionLink(Resources.BackToOfficeList, "GetAll", "Office")
                    </div>
                }

            </div>
        </div>
    </div>
</section>

@section Scripts {

    <script>
        let countrySelect = document.getElementById('countrySelect');

        let regionSelect = document.getElementById('regionSelect');
        regionSelect.disabled = true;

        let citySelect = document.getElementById('citySelect');
        citySelect.disabled = true;

        let countriesUrl = '@Url.Action("GetCountries", "Location")';
        getLocations(countriesUrl, 'GET').then(async countries => {
            fillSelect(countrySelect, countries);

            let keyInput = document.getElementById('officeKey');
            if (keyInput.value.length !== 0) {
                keyInput.disabled = true;
                let countryId = '@Model?.City?.Region?.CountryId';
                countrySelect.value = countryId;
                await fillRegions();
                let regionId = '@Model?.City?.RegionId';
                regionSelect.value = regionId;
                await fillCities();
                let cityId = '@Model?.CityId';
                citySelect.value = cityId;
            }
        });

        countrySelect.addEventListener('change', async function(e) {
            await fillRegions();
            await fillCities();
        });

        regionSelect.addEventListener('change', async function() {
            await fillCities();
        });

        async function getLocations(url, httpMethod) {
            let result = await fetch(url,
                {
                    method: httpMethod,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(async function(response) {
                let locations = await response.json();
                return locations;
            });
            return result;
        }

        function fillSelect(select, array) {
            array.forEach(element => {
                if (element.Name !== "") {
                    let option = new Option(element.Name, element.Id);
                    select.add(option);
                }
            });
        }

        async function fillRegions() {
            let countryId = countrySelect.value;
            let regionsUrl = '/Location/GetRegionsByCountryId?countryId=' + countryId;
            let regions = await getLocations(regionsUrl, 'GET');
            regionSelect.disabled = false;
            regionSelect.options.length = 0;
            fillSelect(regionSelect, regions);
        }

        async function fillCities() {
            let regionId = regionSelect.value;
            let citiesUrl = '/Location/GetCitiesByRegionId?regionId=' + regionId;
            let cities = await getLocations(citiesUrl, 'GET');
            citySelect.disabled = false;
            citySelect.options.length = 0;
            fillSelect(citySelect, cities);
        }
    </script>
}